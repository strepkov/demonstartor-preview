<!DOCTYPE html>
<html>
    <head>
        <title>Autopilot builder</title>
        <meta charset="utf-8">
        <style>
            body {
				margin: 0px;
				overflow: hidden;
			}
        </style>
        <script src="js-libs/jszip.min.js"></script>
    </head>
<body>
    <div>
        <div class="column">
            <iframe onload="cleanOnLoad()" id="ide" src="onlineIDE/api/load.html?mountPoint=[EmbeddedMontiArc]/demonstrator/IDE" height="900" scrolling="no" width="900" align="left"></iframe>
        </div>
        <div id="rightSide1" class="column">
                <div class="row">
                    <iframe id="indexSimulator" src="simulator.html"  height="600" width="686" frameborder="0"></iframe>        
                </div>
                <div class="row">
                    <iframe id="trajectoryComparator" src="trajectoryComparatorMain.html" height="300" frameborder="0" width="686"></iframe>
                </div>
        </div>
        <div id="rightSide2" class="column" style="display: none">
            <!-- Change the way of defining the current tutorial link -->
            <iframe id="tutorialFrame" src="tutorials/html/tutorial00.md.html" height="900" width="686" frameborder="0"></iframe>        
        </div>
    </div>
    <div>
            
            <table>
                <tr>
                    <th><button onclick="appendTestTutorial3()"><b>1a Step</b> : Parking tutorial</button></th>
                    <th rowspan="3"><button onclick="showTutorial()"><b>2 Step</b> : Show tutorial/simulator</button></th>
                    <th rowspan="3"><button id="start" onclick="readAllFiles()"><b>3 Step</b> : Read, pack and send files</button></th>
                </tr>
                <tr>
                    <td><button onclick="appendTestTutorial4()"><b>1b Step</b> : Elk-Test tutorial</button></td>
                </tr>
                <tr>
                    <td><button onclick="appendTestTutorial5()"><b>1c Step</b> : FreeRide tutorial</button></td>
                </tr>
            </table>
            
        <!-- <button onclick="appendTestModel()">Append test file</button> -->
        <!-- <button onclick="clearAllFiles()">Delete all files</button> -->
        <!-- <button onclick="showContent()">Show Content</button> -->
        <!-- <button onclick="packData()">Pack and Send</button> -->
        
        <!-- <div style="width:200px;">
            <select id="tutorialSelect" onchange="showSelectedTutorial()">
              <option value="0">Tutorial0</option>
              <option value="1">Tutorial1</option>
              <option value="2">Tutorial2</option>
              <option value="3">Tutorial3</option>
              <option value="4">Tutorial4</option>
            </select>
        </div> -->
    </div>

    <script>

        // Add the timer for waiting the compilation
        const waitingPeriod = 120; // sec

        function runCountDownTimer(){
            
            var count = waitingPeriod;
            var doc = document.getElementById("indexSimulator").contentWindow.document;
            
            var x = setInterval(function (){
          
                doc.getElementById("notready").innerHTML = "Compiling " + count + "s";
                count--;

                // If the count down is finished, write some text 
                if (count <= 0) {
                    clearInterval(x);
                    doc.getElementById("notready").innerHTML = "Almost done...";
                }
            }, 1000);
        }
        

        function cleanOnLoad(){
            // setTimeout(function(){
            //     if (document.getElementById("ide").contentWindow.api) clearAllFiles();
            // },2000);
        }


        function showSelectedTutorial(){

            var tutorialList = document.getElementById("tutorialSelect");
            var selectedTutorial = tutorialList.options[tutorialList.selectedIndex].value;
            console.log(selectedTutorial);
            
            // The list of tutorials
            var tutorialPath = "tutorials/html/tutorial";
            var tutorialExtension = ".md.html";
            var link = ["00","01","02","03","04"];

            document.getElementById('tutorialFrame').src = tutorialPath + link[selectedTutorial] + tutorialExtension;
        }

        function showTutorial(){

            if(document.getElementById("rightSide2").style.display == 'none'){
                document.getElementById("rightSide1").style.display = 'none';
				document.getElementById("rightSide2").style.display = 'block';
            }else {
                document.getElementById("rightSide1").style.display = 'block';
				document.getElementById("rightSide2").style.display = 'none';
            }
		}

        function disableCompileBtn() {
            document.getElementById("start").disabled = true;
        }

        function enableCompileBtn() {
            document.getElementById("start").disabled = false;
        } 

        function loadMainController(){

            return new Promise((resolve, reject) => {
                var doc = document.getElementById("indexSimulator").contentWindow.document;
                var script_tag = doc.createElement('script');
                script_tag.id = "mainController";
                script_tag.text = rawFileData[0];
                doc.body.appendChild(script_tag);

                setTimeout(()=>{
                    resolve();
                },2000)
            });

        }        

        function overrideReadBinaryWasm(){

            var doc1 = document.getElementById("indexSimulator").contentWindow.document;
            var script_tag1 = doc1.createElement('script');
            script_tag1.id = "mainControllerWasm";
            script_tag1.text = "var Module = {readBinary : function readBinary(filename) {return new Uint8Array(rawWebAssembly);}}";
            doc1.body.appendChild(script_tag1);
        }

        function loadWasmData(){

            document.getElementById("indexSimulator").contentWindow.rawWebAssembly = rawFileData[1];
            
            setTimeout(function(){
                overrideReadBinaryWasm();
            },0);
            
            setTimeout(function(){
                loadMainController().then(
                    document.getElementById("indexSimulator").contentWindow.initSimulator, 
                    ()=>{console.error("error during loading a main controller tag!")});
            },100);
        }

        // TODO: rename and better organize
        function checkWasm(){

            if (checkWasmBinaryData(rawFileData[1])) loadWasmData();
            else enableCompileBtn();
        }
        
        // functions for working with VFS

        function clearAllFiles() {

            var dirRoot = '/';
            var files = [];
            var apiFs = document.getElementById("ide").contentWindow.api.fs;

            apiFs.readdir(dirRoot, function (err, dir) {

                if (err) throw err;
            
                const start = async () => {
                    await Promise.all(dir.map(async item => {
                        // The folder(item) has to be a root directory for a model
                        if (item.mime == "folder" && !(item.name).includes(".")) {

                            await readDirAsync(item, files);
                            removeDir(item);
                        }
                }))}
                
                start();
            });
        }

        function readDirAsync(dir, filesArray){
            return new Promise(r => {
                var apiFs = document.getElementById("ide").contentWindow.api.fs;
                apiFs.readdir( dir.fullPath, function (err, dirInternal) {
                    if (err) throw err;
                    // filesArray.push(dirInternal);
                    const removeFiles = async () =>{
                            await Promise.all(dirInternal.map(async file => {
                                await removeFile(apiFs,file);
                            }));
                    }
                    removeFiles();
                    r();
                })});
        }

        function removeFile(apiFs, file) {
            return new Promise(r => {
                document.getElementById("ide").contentWindow.api.fs.rmfile(file.fullPath, err => {
                    if (err) throw err;
                });
                console.log(file.fullPath," deleted!");
                r();
            });
        }

        function removeDir(dir) {
            return new Promise(r => {
                document.getElementById("ide").contentWindow.api.fs.rmdir(dir.fullPath, e => {
                    if (e) return console.error(e);
                    console.log("The directory " + dir.fullPath + " is deleted");
                    r();
                });
            });
        }

        function appendFile(fileName,fileContent){
            return new Promise(r => {
                document.getElementById("ide").contentWindow.api.fs.appendFile(fileName,fileContent, e => {
                    if (e) throw e;
                });
                filesFromDiskData.push(fileContent); // Save data from disk to array
                console.log("Added file : " + fileName);
                r();
            });
        }

        function appendDir(dirName){
            return new Promise(r => {
                document.getElementById("ide").contentWindow.api.fs.mkdir(dirName, e => {
                    if (e) throw e;
                });
                console.log("Added dir : " + dirName);
                r();
            });
        }
        // end

        function readFileFromDisk(file) {
            var oReq = new XMLHttpRequest();
            var text;
            oReq.open("GET", file, false);
            oReq.onreadystatechange = function () {
                if (oReq.readyState === 4) {
                    if (oReq.status === 200 || oReq.status == 0) {
                        text = oReq.responseText;
                    }
                }
            }
            oReq.onerror = function(){
                    console.log("error disk reading!");
                }
            oReq.send(null);
            return text;
        }
        
        var activeTutorial = 0;

        function appendTestTutorial3(){
           
            clearAllFiles();
            document.getElementById('tutorialFrame').src = "tutorials/html/tutorial03.md.html";
            
            setTimeout(function(){
                filesFromDiskData = [];
                appendDir("/controller03");
                appendFile("/controller03/MainController.emam", readFileFromDisk("tutorials/controllers/controller03/MainController.emam"));
                appendFile("/controller03/ParkingController.emam", readFileFromDisk("tutorials/controllers/controller03/ParkingController.emam"));
                appendFile("/controller03/SearchParkingPlaceController.emam", readFileFromDisk("tutorials/controllers/controller03/SearchParkingPlaceController.emam"));
                appendFile("/controller03/VelocityController.emam", readFileFromDisk("tutorials/controllers/controller03/VelocityController.emam"));
            },500);

            document.getElementById("indexSimulator").contentWindow.presentationObjects = 3;
            if (document.getElementById("indexSimulator").contentWindow.objectsOnTrack.length > 1)
                document.getElementById("indexSimulator").contentWindow.deleteCones();
                document.getElementById("indexSimulator").contentWindow.showCars();
                document.getElementById("indexSimulator").contentWindow.setPosition(
                    document.getElementById("indexSimulator").contentWindow.currentCar, 0, 0.2, 0);
                document.getElementById("indexSimulator").contentWindow.rotateCar(
                    document.getElementById("indexSimulator").contentWindow.currentCar, 0);

            activeTutorial = 3;
        }

        function appendTestTutorial4(){

            clearAllFiles();
            document.getElementById('tutorialFrame').src = "tutorials/html/tutorial04.md.html";
    
            setTimeout(function(){
                filesFromDiskData = [];
                appendDir("/controller04");
                appendFile("controller04/MainController.emam", readFileFromDisk("tutorials/controllers/controller04/MainController.emam"));
                appendFile("controller04/ConeRunner.emam", readFileFromDisk("tutorials/controllers/controller04/ConeRunner.emam"));
                appendFile("controller04/VelocityController.emam", readFileFromDisk("tutorials/controllers/controller04/VelocityController.emam"));
            },500);

            document.getElementById("indexSimulator").contentWindow.presentationObjects = 4;

            if (document.getElementById("indexSimulator").contentWindow.objectsOnTrack.length < 1){
                document.getElementById("indexSimulator").contentWindow.showCones();
                document.getElementById("indexSimulator").contentWindow.hideCars();
                document.getElementById("indexSimulator").contentWindow.setPosition(
                    document.getElementById("indexSimulator").contentWindow.currentCar, 1, 0.2, -100);
                document.getElementById("indexSimulator").contentWindow.rotateCar(
                    document.getElementById("indexSimulator").contentWindow.currentCar, 0);
            }

            activeTutorial = 4;
        }

        function appendTestTutorial5() {

            clearAllFiles();
            
            document.getElementById('tutorialFrame').src = "tutorials/html/tutorial04.md.html";
            
            setTimeout(function () {
                filesFromDiskData = [];
                appendDir("/controller05");
                appendFile("controller05/MainController.emam", readFileFromDisk("tutorials/controllers/controller05/MainController.emam"));
                appendFile("controller05/PassObjectsController.emam", readFileFromDisk("tutorials/controllers/controller05/PassObjectsController.emam"));
                appendFile("controller05/VelocityController.emam", readFileFromDisk("tutorials/controllers/controller05/VelocityController.emam"));
                appendFile("controller05/ActiveController.emam", readFileFromDisk("tutorials/controllers/controller05/ActiveController.emam"));
                appendFile("controller05/SearchParkingPlaceController.emam", readFileFromDisk("tutorials/controllers/controller05/SearchParkingPlaceController.emam"));
                appendFile("controller05/ParkingController.emam", readFileFromDisk("tutorials/controllers/controller05/ParkingController.emam"));
                appendFile("controller05/SteeringProxyController.emam", readFileFromDisk("tutorials/controllers/controller05/SteeringProxyController.emam"));
            }, 500);
            
            document.getElementById("indexSimulator").contentWindow.presentationObjects = 5;

            document.getElementById("indexSimulator").contentWindow.deleteCones();
            document.getElementById("indexSimulator").contentWindow.hideCars();

            document.getElementById("indexSimulator").contentWindow.showCones2();
            document.getElementById("indexSimulator").contentWindow.showCars2();
            document.getElementById("indexSimulator").contentWindow.setPosition(
                document.getElementById("indexSimulator").contentWindow.currentCar, 1, 0.2, -120);
            
            document.getElementById("indexSimulator").contentWindow.rotateCar(
                document.getElementById("indexSimulator").contentWindow.currentCar, 0);
                
            activeTutorial = 5;
        }

        // Read files from ide and pack
        var filesData = Array();
        var fileNames = Array();

        function readFileName(name) {
            
            document.getElementById("ide").contentWindow.api.fs.readFile('/' + name, function (err, data) {
                if (err) throw err;
                filesData.push(data);
                fileNames.push(name);
            });
        }

        // Files from tutorial folder
        var filesFromDiskData = Array();

        function isContentWasChanged(){
            var check = true;
            if(filesData.length == filesFromDiskData.length){
                check = false;
                for(var i=0; i<filesData.length; i++){
                   if (filesData[i] != filesFromDiskData[i]){
                        check = true;
                        console.log("file ", fileNames[i]," was changed!");
                   }
                }
            }
            return check;
        }

        // related to the issue with HTTPS certificate
        var firstTimeRunAlert = false;

        function showAlertHTTPS(){

            if (!firstTimeRunAlert) {
                alert("There is an security issue with the connection to the server RWTH-Aachen. It does not have HTTPS certificate yet. To be able to send the data to the server, please allow executing the insecure content. \n In the Chrome browser, the small shield is appeared in the upper right conner, just click on in and then click on - Load unsafe scripts. Then, try please send again. \n We are really sorry for inconvenience. Thank you for your understanding.");
                firstTimeRunAlert = true;
            }
        }

        // traverse the folder(project name) 
        function readAllFiles() {

            disableCompileBtn();
            document.getElementById("indexSimulator").contentWindow.notReadyToGo();
            

            filesData = [];
            fileNames = [];
            var dirRoot = '/';
            var folderName;
            
            var apiFs = document.getElementById("ide").contentWindow.api.fs;
            
            apiFs.readdir(dirRoot,function (err, dir){
                
                if (err) throw err;
                dir.forEach( function (item){
                    // The folder(item) has to be a root directory for a model
                    if(item.mime == "folder" && !(item.name).includes(".")){

                        folderName = item.name;
                        apiFs.readdir(dirRoot+item.name, function (err, dirInternal){
                
                            if (err) throw err;
                            dirInternal.forEach( function (file){
             
                                if((file.name).includes(".emam") || (file.name).includes(".stream")){
                                    readFileName(item.name + "/" +file.name);
                                }
                            });
                        });
                        
                    }
                });
            });
            
            setTimeout(function(){
                if(isContentWasChanged()){
                    showAlertHTTPS();
                    packData(folderName).then(sendData, function () {
                        console.log("packing problem happened!");
                    });
                } else {
                    console.log("The content of the files haven't been changed!");
                    // we can just read data from folder
                    filesFromDisk = [];

                    if(activeTutorial == 3){
                        console.log("activeTutorial ",activeTutorial);
                        readFileFromDiskBlob("tutorials/compiledControllers/parkingTutorial/mainController.wasm");
                        filesFromDisk[1] = readFileFromDisk("tutorials/compiledControllers/parkingTutorial/mainController.js");
                    }
                    if(activeTutorial == 4){
                        console.log("activeTutorial ",activeTutorial);
                        readFileFromDiskBlob("tutorials/compiledControllers/elkTestTutorial/mainController.wasm");
                        filesFromDisk[1] = readFileFromDisk("tutorials/compiledControllers/elkTestTutorial/mainController.js");
                    }

                    setTimeout(function () {
                        
                        if(checkWasmBinaryData(filesFromDisk[0])){
                            document.getElementById("indexSimulator").contentWindow.rawWebAssembly = filesFromDisk[0];

                            setTimeout(function () {
                                overrideReadBinaryWasm();
                            }, 100);

                            setTimeout(function () {
                                loadMainController2().then(
                                    document.getElementById("indexSimulator").contentWindow.initSimulator,
                                    () => { console.error("error during loading a main controller tag!") });
                            }, 100);
                        } else {
                            console.log(".wasm file error!");
                            enableCompileBtn();
                        }
                    }, 100);
                }
            },500);
        }

        // Controller from disc
        function loadMainController2() {
            
            return new Promise((resolve, reject) => {
                var doc = document.getElementById("indexSimulator").contentWindow.document;
                var script_tag = doc.createElement('script');
                script_tag.id = "mainController";
                script_tag.text = filesFromDisk[1];
                doc.body.appendChild(script_tag);
                setTimeout(() => {
                    resolve();
                }, 2000)
            });
        }  

        // Read file to replace compiled ones
        var filesFromDisk = new Array();

        function readFileFromDiskBlob(filePath) {
            var oReq = new XMLHttpRequest();
            oReq.open("GET", filePath, true);
            oReq.responseType = "arraybuffer";
            oReq.onload = function(){
                var arrayBuffer = oReq.response; // Note: not oReq.responseText
                if (arrayBuffer) {
                    var byteArray = new Uint8Array(arrayBuffer);
                    if(byteArray.byteLength){
                        filesFromDisk[0] = byteArray;
                    } else 
                        console.error("Problem with reading .wasm file!");
                }
            }
            oReq.send(null);
        }

        // show the content which was red from IDE
        function showContent(){

            fileNames.forEach(function(item,index){
                console.log(item);
                console.log(filesData[index]);
            });
        }

        var zipContainer = new JSZip();
        var packCounter = 0;

        function packData(folderName){
            return new Promise(r => {
                const packFiles = async () =>{
                    await Promise.all(fileNames.map(async function(item,index){
                        await zipContainer.file(item, filesData[index]);
                        console.log(item," was packed!");
                        packCounter++;
                    }));
                }
                packFiles();
                r();
            });
        }

        function sendData(){
            if(packCounter < 2){
                console.log("Error during archiving process! Please try again.");
                document.getElementById("indexSimulator").contentWindow.document
                    .getElementById("notready").innerHTML = "Please, send again! Error during packing!";
                packCounter = 0;
                return;
            }
            packCounter = 0;
            var t0 = performance.now();
            zipContainer.generateAsync({type:"blob"}).then(function (content) {
                
                var blob1 = new Blob([content], {type: 'application/octet-binary'});
                var xhr = new XMLHttpRequest();
                xhr.open("POST", 'http://137.226.168.11:80/receiver/', true);
                //xhr.open("POST", 'http://0.0.0.0:7070/receiver/', true);
                xhr.send(blob1);
                console.log("files were sent to the server, waiting for responce...");
                // TODO: why the server does not set response type?
                xhr.responseType = "blob";
                
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        if (xhr.status == 200){
                            var t1 = performance.now();
                            // Write to the console a compilation time
                            console.log("Compilation time: " + ((t1 - t0)/1000) + " seconds.");
                            saveFileFromResponse(xhr.response);    
                        }
                        if (xhr.status == 500){
                            
                            console.log(xhr.status);
                            console.log(xhr.statusText);
                            enableCompileBtn();
                        }
                    }
                }
            });
            runCountDownTimer();
        }

        // TODO: save file from variable to VFS

        var rawFileData = new Array();

        function saveFileFromResponse(receivedDataFromServer){

            // delete files from previous compilation
            while (rawFileData.length) 
					{   
                        console.log("clean previous data from server!");
						rawFileData.pop(); 
					}

            var new_zip = new JSZip();

            new_zip.loadAsync(receivedDataFromServer).then(function (zip) {
                Object.keys(zip.files).forEach(function (filename) {
                    if(filename.includes("wasm")){
                        zip.files[filename].async('uint8array').then(function (fileData) {
                        console.log(filename);
                        //appendFile(".home/" + filename, fileData);
                        rawFileData.push(fileData);
                    });}
                    else{
                    zip.files[filename].async('string').then(function (fileData) {
                        console.log(filename);
                        //appendFile(".home/" + filename, fileData);
                        rawFileData.push(fileData);
                    });
                    }
                });
            });
            
            // wait for async unpack
            setTimeout(function(){
                checkWasm();
            }, 500);
        }

        function checkWasmBinaryData(data){
                
            var valid = false;
            
            if (data != undefined){
                valid = WebAssembly.validate(data);
                console.log("The given bytes are "
                    + (valid ? "" : "not ") + "a valid wasm module"); 
            }
            return valid;            
        }

        function showLogs(flag){
            document.getElementById("indexSimulator").contentWindow.showLogsData = flag;
            return "set " + flag;
        }

        function getSimulationLog(){
            var simulationLog = document.getElementById("indexSimulator").contentWindow.logObject;
            document.getElementById("trajectoryComparator").contentWindow.fillSimulationData(simulationLog);
        }

        function reloadTrajectoryPage(){
            console.log("reload!");
            document.getElementById('trajectoryComparator').contentWindow.location.reload();
        }
        
    </script>
</body>
</html>